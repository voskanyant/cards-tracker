{% extends "core/base.html" %}
{% block content %}
<section class="section-card">
  <h2 style="margin-top:0;">Add Client</h2>
  <form method="post" class="form-grid">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for field in form %}
      {% if field.name == "notes" %}
        {% with has_value=field.value %}
        <div class="notes-field{% if has_value or field.errors %} is-open{% endif %}" style="grid-column:1/-1;">
          <div class="notes-header">
            <span>{{ field.label }}</span>
            <button type="button" class="notes-trigger" data-note-target="notes-{{ field.auto_id }}">Add note</button>
          </div>
          <div class="notes-collapse" id="notes-{{ field.auto_id }}">
            {{ field }}
            {% if field.errors %}
              <small style="color:#c00;">{{ field.errors|join:", " }}</small>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% else %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          {{ field }}
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% endif %}
    {% endfor %}
    <div style="grid-column:1/-1; display:flex; justify-content:flex-end;">
      <button type="submit">Save Client</button>
    </div>
  </form>
</section>

<section class="section-card">
  <div style="display:flex; flex-direction:column; gap:12px;">
    <div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; align-items:center;">
      <h2 style="margin:0;">Clients</h2>
      <a class="clients-export" href="/clients/export/{% if query %}?q={{ query|urlencode }}{% endif %}">Export CSV</a>
    </div>
    <div class="clients-controls">
      <label class="clients-search" style="display:flex; flex-direction:column;">
        <span>Search</span>
        <input type="text" name="q" placeholder="Search clients..." value="{{ query }}">
      </label>
      <label class="clients-per-page" style="display:flex; flex-direction:column;">
        <span>Per page</span>
        <select name="per_page">
          {% for option in per_page_choices %}
            <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>{{ option }}</option>
          {% endfor %}
        </select>
      </label>
    </div>
  </div>

  <div class="table-card table-scroll mobile-cards" style="margin-top:16px;">
    <table>
      <thead>
        <tr><th>Name</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody data-initial-html>
        {% for c in page_obj %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.status }}</td>
            <td style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <a href="/clients/{{ c.id }}/edit/">Edit</a>
              <form method="post" action="{% url 'client_delete' c.id %}" style="display:inline;" onsubmit="return confirm('Delete this client?');">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" style="background:none;border:none;color:#c00;padding:0;margin:0;cursor:pointer;font:inherit;">Delete</button>
              </form>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="3">No clients yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if page_obj.has_other_pages %}
    <div class="pagination" style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      {% if page_obj.has_previous %}
        <a href="?{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Prev</a>
      {% endif %}
      {% for num in page_items %}
        {% if num %}
          {% if num == page_obj.number %}
            <span style="padding:4px 8px; border-radius:8px; background:#e2e8f0; font-weight:600;">{{ num }}</span>
          {% else %}
            <a href="?{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ num }}" style="padding:4px 8px;">{{ num }}</a>
          {% endif %}
        {% else %}
          <span style="padding:4px 6px; color:var(--muted);">...</span>
        {% endif %}
      {% endfor %}
      {% if page_obj.has_next %}
        <a href="?{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
      {% endif %}
    </div>
  {% endif %}
</section>
<script>
  (function () {
    const input = document.querySelector("input[name='q']");
    const tbody = document.querySelector("table tbody");
    const pagination = document.querySelector(".pagination");
    const perPageSelect = document.querySelector("select[name='per_page']");
    const controls = document.querySelector(".clients-controls");
    const exportLink = document.querySelector("a[href^='/clients/export/']");
    const initialBody = tbody ? tbody.innerHTML : "";
    const initialPagination = pagination ? pagination.innerHTML : "";
    const initialPaginationDisplay = pagination ? pagination.style.display : "";
    let controller = null;
    if (!input) return;

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        return parts.pop().split(";").shift();
      }
      return "";
    }

    function setUrlQuery(term) {
      const params = new URLSearchParams(window.location.search);
      if (term) {
        params.set("q", term);
      } else {
        params.delete("q");
      }
      if (perPageSelect) {
        params.set("per_page", perPageSelect.value);
      }
      params.delete("page");
      const query = params.toString();
      const url = query ? `${window.location.pathname}?${query}` : window.location.pathname;
      window.history.replaceState({}, "", url);
    }

    function renderRows(items) {
      if (!tbody) return;
      if (!items.length) {
        tbody.innerHTML = "<tr><td colspan=\"3\">No matching clients.</td></tr>";
        return;
      }
      const csrf = getCookie("csrftoken");
      const nextValue = window.location.pathname + window.location.search;
      tbody.innerHTML = items
        .map(item => {
          const id = escapeHtml(item.id);
          const name = escapeHtml(item.name);
          const status = escapeHtml(item.status);
          return `
            <tr>
              <td>${name}</td>
              <td>${status}</td>
              <td style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                <a href="/clients/${id}/edit/">Edit</a>
                <form method="post" action="/clients/${id}/delete/" style="display:inline;" onsubmit="return confirm('Delete this client?');">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${csrf}">
                  <input type="hidden" name="next" value="${escapeHtml(nextValue)}">
                  <button type="submit" style="background:none;border:none;color:#c00;padding:0;margin:0;cursor:pointer;font:inherit;">Delete</button>
                </form>
              </td>
            </tr>
          `;
        })
        .join("");
    }

    function togglePagination(show) {
      if (!pagination) return;
      pagination.style.display = show ? initialPaginationDisplay || "" : "none";
    }

    function toggleControls(show) {
      if (!controls) return;
      controls.style.display = show ? "" : "none";
    }

    function restoreInitial() {
      if (tbody) tbody.innerHTML = initialBody;
      if (pagination) pagination.innerHTML = initialPagination;
      togglePagination(true);
      toggleControls(true);
    }

    function applySearch() {
      const term = input.value.trim();
      if (exportLink) {
        exportLink.href = term ? `/clients/export/?q=${encodeURIComponent(term)}` : "/clients/export/";
      }
      setUrlQuery(term);
      if (!term) {
        restoreInitial();
        return;
      }
      togglePagination(false);
      toggleControls(false);
      if (controller) controller.abort();
      controller = new AbortController();
      fetch(`/clients/search/?q=${encodeURIComponent(term)}`, { signal: controller.signal })
        .then(resp => resp.ok ? resp.json() : { results: [] })
        .then(data => renderRows(data.results || []))
        .catch(() => {});
    }

    let timer;
    input.addEventListener("input", () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(applySearch, 200);
    });
    if (perPageSelect) {
      perPageSelect.addEventListener("change", () => {
        const params = new URLSearchParams(window.location.search);
        params.set("per_page", perPageSelect.value);
        params.delete("page");
        const query = params.toString();
        window.location.href = query ? `${window.location.pathname}?${query}` : window.location.pathname;
      });
    }
    applySearch();
  })();
</script>
{% endblock %}
