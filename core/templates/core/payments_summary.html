{% extends "core/base.html" %}
{% load formatting %}
{% block content %}
<style>
  .payments-table {
    width: 100%;
    min-width: 0 !important;
  }
  .payments-table .copyable {
    cursor: pointer;
  }
  .payments-table .copyable:active {
    opacity: 0.7;
  }
  .copy-toast {
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: #111;
    color: #fff;
    padding: 6px 12px;
    border-radius: 999px;
    font-size: 0.85rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 200;
  }
  .copy-toast.is-visible {
    opacity: 0.9;
  }
  .payments-filters .search-per-page-row {
    display: grid;
    grid-template-columns: minmax(0, 1fr) minmax(0, 140px);
    gap: 12px;
    align-items: end;
    width: 100%;
  }
  .payments-filters .search-per-page-row .filter-search,
  .payments-filters .search-per-page-row .payments-per-page {
    min-width: 0;
  }
  @media (max-width: 720px) {
    html,
    body {
      overflow-x: hidden;
    }
    .table-card.table-scroll {
      overflow-x: hidden;
    }
    .payments-filters {
      display: grid !important;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px 12px;
    }
    .payments-filters .search-per-page-row {
      grid-template-columns: minmax(0, 4fr) minmax(0, 1fr);
      gap: 10px;
      grid-column: 1 / -1;
    }
    .payments-filters label {
      min-width: 0;
    }
    .payments-filters .search-per-page-row input,
    .payments-filters .search-per-page-row select {
      min-height: 44px;
    }
    .payments-table {
      width: 100%;
      min-width: 0 !important;
      table-layout: fixed;
    }
    .payments-table thead {
      display: none;
    }
    .payments-table tbody {
      display: block;
      width: 100%;
    }
    .payments-table tr {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "date client"
        "rub usd";
      gap: 6px 12px;
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
    }
    .payments-table td {
      display: block;
      padding: 6px 0;
      border: none;
      min-width: 0;
    }
    .payments-table td:nth-child(1) { grid-area: date; font-weight: 600; }
    .payments-table td:nth-child(2) { grid-area: client; font-weight: 600; }
    .payments-table td:nth-child(3) { grid-area: rub; color: var(--muted); font-size: 0.9rem; }
    .payments-table td:nth-child(4) { grid-area: usd; color: var(--muted); font-size: 0.9rem; }
  }
</style>
<section class="section-card">
  <div style="display:flex; flex-direction:column; gap:12px;">
    <div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; align-items:center;">
      <h2 style="margin:0;">Payments Summary</h2>
      <a href="/payments/export/{% if start or end or query %}?{% endif %}{% if start %}start={{ start|urlencode }}{% if end or query %}&{% endif %}{% endif %}{% if end %}end={{ end|urlencode }}{% if query %}&{% endif %}{% endif %}{% if query %}q={{ query|urlencode }}{% endif %}" data-initial="/payments/export/{% if start or end or query %}?{% endif %}{% if start %}start={{ start|urlencode }}{% if end or query %}&{% endif %}{% endif %}{% if end %}end={{ end|urlencode }}{% if query %}&{% endif %}{% endif %}{% if query %}q={{ query|urlencode }}{% endif %}">Export CSV</a>
    </div>
    <form method="get" class="payments-filters" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; width:100%;">
      <label style="display:flex; flex-direction:column;">
        <span>From</span>
        <div class="date-field">
          <input type="text" name="start" placeholder="dd/mm/yyyy" value="{{ start }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
          <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
        </div>
      </label>
      <label style="display:flex; flex-direction:column;">
        <span>To</span>
        <div class="date-field">
          <input type="text" name="end" placeholder="dd/mm/yyyy" value="{{ end }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
          <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
        </div>
      </label>
      <div class="search-per-page-row">
        <label class="filter-search" style="display:flex; flex-direction:column; min-width:220px; flex:1;">
          <span>Search</span>
          <input type="text" name="q" placeholder="Search client..." value="{{ query }}">
        </label>
        <label class="payments-per-page" style="display:flex; flex-direction:column;">
          <span>Per page</span>
          <select name="per_page">
            {% for option in per_page_choices %}
              <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </label>
      </div>
    </form>
  </div>

  <div class="table-card table-scroll mobile-cards" style="margin-top:16px;">
    <table class="payments-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Client</th>
          <th class="num col-narrow">Received RUB ₽</th>
          <th class="num col-narrow">Received USD $</th>
        </tr>
      </thead>
      <tbody>
        {% for row in rows %}
          <tr>
            <td>{{ row.date|date:"d/m/Y" }}</td>
            <td class="copyable" data-copy="{{ row.client.name }}">{{ row.client.name }}</td>
            <td class="num copyable" data-copy="{{ row.rub|spaced_number }}">{{ row.rub|spaced_number }} &#8381;</td>
            <td class="num copyable" data-copy="{{ row.usd|spaced_number }}">{{ row.usd|spaced_number }} $</td>
          </tr>
        {% empty %}
          <tr><td colspan="4">No payments found for the selected range.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if page_obj and page_obj.has_other_pages %}
    <div class="pagination" style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      {% if page_obj.has_previous %}
        <a href="?{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Prev</a>
      {% endif %}
      {% for num in page_items %}
        {% if num %}
          {% if num == page_obj.number %}
            <span style="padding:4px 8px; border-radius:8px; background:#e2e8f0; font-weight:600;">{{ num }}</span>
          {% else %}
            <a href="?{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ num }}" style="padding:4px 8px;">{{ num }}</a>
          {% endif %}
        {% else %}
          <span style="padding:4px 6px; color:var(--muted);">...</span>
        {% endif %}
      {% endfor %}
      {% if page_obj.has_next %}
        <a href="?{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
      {% endif %}
    </div>
  {% endif %}
</section>
<div class="copy-toast" id="payments-copy-toast">Copied</div>
<script>
  (function () {
    const searchInput = document.querySelector("input[name='q']");
    const tbody = document.querySelector(".table-card table tbody");
    const pagination = document.querySelector(".pagination");
    const perPageLabel = document.querySelector(".payments-per-page");
    const perPageSelect = document.querySelector("select[name='per_page']");
    const exportLink = document.querySelector("a[href^='/payments/export/']");
    if (!searchInput || !tbody) return;

    const initialBody = tbody.innerHTML;
    const initialPagination = pagination ? pagination.innerHTML : "";
    const initialPaginationDisplay = pagination ? pagination.style.display : "";
    let controller = null;
    let timer;

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function getValue(selector) {
      const el = document.querySelector(selector);
      return el ? el.value.trim() : "";
    }

    function buildParams(includeQuery) {
      const params = new URLSearchParams();
      const start = getValue("input[name='start']");
      const end = getValue("input[name='end']");
      const query = includeQuery ? searchInput.value.trim() : "";
      if (start) params.set("start", start);
      if (end) params.set("end", end);
      if (query) params.set("q", query);
      return params;
    }

    function updateExportLink(queryParams) {
      if (!exportLink) return;
      const query = queryParams.toString();
      exportLink.href = query ? `/payments/export/?${query}` : "/payments/export/";
    }

    function renderRows(items) {
      if (!items.length) {
        tbody.innerHTML = "<tr><td colspan=\"4\">No payments found for the selected range.</td></tr>";
        return;
      }
      tbody.innerHTML = items
        .map(row => {
          const date = escapeHtml(row.date);
          const client = escapeHtml(row.client);
          const rub = escapeHtml(row.rub);
          const usd = escapeHtml(row.usd);
          return `
            <tr>
              <td>${date}</td>
              <td class="copyable" data-copy="${client}">${client}</td>
                <td class="num copyable" data-copy="${rub}">${rub} ₽</td>
                <td class="num copyable" data-copy="${usd}">${usd} $</td>
            </tr>
          `;
        })
        .join("");
    }

    function restoreInitial() {
      tbody.innerHTML = initialBody;
      if (pagination) pagination.innerHTML = initialPagination;
      if (exportLink) exportLink.href = exportLink.dataset.initial || exportLink.href;
      togglePagination(true);
      togglePerPage(true);
    }

    function togglePagination(show) {
      if (!pagination) return;
      pagination.style.display = show ? initialPaginationDisplay || "" : "none";
    }

    function togglePerPage(show) {
      if (!perPageLabel) return;
      perPageLabel.style.display = show ? "" : "none";
    }

    function applyFilters() {
      const start = getValue("input[name='start']");
      const end = getValue("input[name='end']");
      const term = searchInput.value.trim();
      const hasFilters = Boolean(start || end || term);
      updateExportLink(buildParams(hasFilters));
      if (!hasFilters) {
        restoreInitial();
        return;
      }
      togglePagination(false);
      togglePerPage(false);
      if (controller) controller.abort();
      controller = new AbortController();
      const params = buildParams(true);
      fetch(`/payments/search/?${params.toString()}`, { signal: controller.signal })
        .then(resp => resp.ok ? resp.json() : { results: [] })
        .then(data => renderRows(data.results || []))
        .catch(() => {});
    }

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });
    searchInput.addEventListener("input", () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(applyFilters, 200);
    });
    const startInput = document.querySelector("input[name='start']");
    const endInput = document.querySelector("input[name='end']");
    if (startInput) {
      startInput.addEventListener("change", applyFilters);
      startInput.addEventListener("input", () => {
        if (!startInput.value.trim()) {
          applyFilters();
        }
      });
    }
    if (endInput) {
      endInput.addEventListener("change", applyFilters);
      endInput.addEventListener("input", () => {
        if (!endInput.value.trim()) {
          applyFilters();
        }
      });
    }
    document.addEventListener("click", (event) => {
      const target = event.target;
      if (target && target.matches("button[data-action='clear']")) {
        setTimeout(applyFilters, 0);
      }
    });
    if (perPageSelect) {
      perPageSelect.addEventListener("change", () => {
        const params = buildParams(true);
        params.set("per_page", perPageSelect.value);
        params.delete("page");
        const query = params.toString();
        window.location.href = query ? `${window.location.pathname}?${query}` : window.location.pathname;
      });
    }
    applyFilters();
  })();
</script>
<script>
  (function () {
    const table = document.querySelector(".payments-table");
    const toast = document.getElementById("payments-copy-toast");
    if (!table) return;
    let toastTimer = null;

    function copyText(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
        return;
      }
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.opacity = "0";
      document.body.appendChild(textarea);
      textarea.select();
      try {
        document.execCommand("copy");
      } catch (e) {}
      textarea.remove();
    }

    table.addEventListener("click", (event) => {
      const cell = event.target.closest(".copyable");
      if (!cell) return;
      const value = cell.getAttribute("data-copy") || cell.textContent || "";
      copyText(value.trim());
      if (toast) {
        toast.classList.add("is-visible");
        window.clearTimeout(toastTimer);
        toastTimer = window.setTimeout(() => {
          toast.classList.remove("is-visible");
        }, 900);
      }
    });
  })();
</script>

{% endblock %}
