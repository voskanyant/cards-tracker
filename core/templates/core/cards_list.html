{% extends "core/base.html" %}
{% load formatting %}
{% block content %}
<section class="section-card">
  <h2 style="margin-top:0;">Add Card</h2>
  <form method="post" class="form-grid">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for field in form %}
      {% if field.name == "notes" %}
        {% with has_value=field.value %}
        <div class="notes-field{% if has_value or field.errors %} is-open{% endif %}" style="grid-column:1/-1;">
          <div class="notes-header">
            <span>{{ field.label }}</span>
            <button type="button" class="notes-trigger" data-note-target="notes-{{ field.auto_id }}">Add note</button>
          </div>
          <div class="notes-collapse" id="notes-{{ field.auto_id }}">
            {{ field }}
            {% if field.errors %}
              <small style="color:#c00;">{{ field.errors|join:", " }}</small>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% elif field.name == "group_name" %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="combo-wrapper" data-combo-list="group-options">
            {{ field }}
            <div class="combo-dropdown"></div>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% elif field.name == "bank" %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="combo-wrapper" data-combo-list="bank-options">
            {{ field }}
            <div class="combo-dropdown"></div>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% else %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          {{ field }}
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% endif %}
    {% endfor %}
    <div style="grid-column:1/-1; display:flex; justify-content:flex-end;">
      <button type="submit">Save Card</button>
    </div>
  </form>
</section>

<datalist id="group-options">
  {% for group in groups %}
    <option value="{{ group.name }}"></option>
  {% endfor %}
</datalist>
<datalist id="bank-options">
  {% for bank in banks %}
    <option value="{{ bank }}"></option>
  {% endfor %}
</datalist>


<section class="section-card">
  <div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; align-items:center;">
    <h2 style="margin:0;">Cards</h2>
    <form method="get" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
      <label style="display:flex; flex-direction:column; min-width:200px;">
        <span>Bank</span>
        <div class="combo-wrapper" data-combo-list="bank-options" data-combo-target="cards-bank-filter">
          <input type="hidden" name="bank" id="cards-bank-filter" value="{{ bank_filter }}">
          <input type="text" value="{{ bank_filter }}" placeholder="Start typing bank..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="combo-input">
          <div class="combo-dropdown"></div>
        </div>
      </label>
      <label style="display:flex; flex-direction:column; min-width:200px;">
        <span>Group</span>
        <div class="combo-wrapper" data-combo-list="group-options" data-combo-target="cards-group-filter">
          <input type="hidden" name="group" id="cards-group-filter" value="{{ group_filter }}">
          <input type="text" value="{{ group_filter }}" placeholder="Start typing group..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="combo-input">
          <div class="combo-dropdown"></div>
        </div>
      </label>
      <label style="display:flex; flex-direction:column;">
        <span>From</span>
        <div class="date-field">
          <input type="text" name="start" placeholder="dd/mm/yyyy" value="{{ start }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
          <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
        </div>
      </label>
      <label style="display:flex; flex-direction:column;">
        <span>To</span>
        <div class="date-field">
          <input type="text" name="end" placeholder="dd/mm/yyyy" value="{{ end }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
          <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
        </div>
      </label>
      <div>
        <button type="submit">Apply</button>
        <a href="/cards/" style="margin-left:8px;">Reset</a>
      </div>
    </form>
  </div>

  <div class="table-card table-scroll" style="margin-top:16px;">
    <table class="cards-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Bank</th>
          <th>Group</th>
          <th>Number</th>
          <th>PIN</th>
          <th class="num col-narrow">Received</th>
          <th class="num col-narrow">Withdrawn</th>
          <th class="num col-narrow">Commission</th>
          <th class="num col-narrow">Balance</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in cards %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ c.bank }}</td>
            <td>{% if c.group %}{{ c.group.name }}{% else %}-{% endif %}</td>
            <td>{{ c.card_number }}</td>
            <td>{{ c.pin }}</td>
            <td class="num">{{ c.received_total|spaced_number }}</td>
            <td class="num">{{ c.withdrawn_total|spaced_number }}</td>
            <td class="num">{{ c.commission_total|spaced_number }}</td>
            <td class="num">{{ c.balance_total|spaced_number }}</td>
            <td style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <a href="/cards/{{ c.id }}/edit/">Edit</a>
              <a href="/cards/{{ c.id }}/history/?start={{ start|urlencode }}&end={{ end|urlencode }}">History</a>
              <form method="post" action="{% url 'card_delete' c.id %}" style="display:inline;" onsubmit="return confirm('Delete this card?');">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" style="background:none;border:none;color:#c00;padding:0;margin:0;cursor:pointer;font:inherit;">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="table-card" style="margin-top:16px;">
    <table>
      <thead>
        <tr><th>Total Received</th><th>Total Withdrawn</th><th>Total Commission</th><th>Balance</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ overall.received|spaced_number }}</td>
          <td>{{ overall.withdrawn|spaced_number }}</td>
          <td>{{ overall.commission|spaced_number }}</td>
          <td>{{ overall.balance|spaced_number }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
{% endblock %}
