{% extends "core/base.html" %}
{% load formatting %}
{% block content %}
<style>
  .add-card-toggle {
    display: none;
    align-items: center;
    gap: 8px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
  }
  .add-card-toggle:focus {
    outline: none;
    border-color: var(--text);
  }
  .add-card-body {
    width: 100%;
  }
  @media (max-width: 720px) {
    .add-card-toggle {
      display: flex;
    }
    .add-card-body {
      display: none;
    }
    .add-card-body.is-open {
      display: block;
      margin-top: 12px;
    }
    .cards-filters {
      display: grid !important;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px 12px;
    }
    .cards-filters label {
      min-width: 0 !important;
    }
    .cards-table {
      width: 100%;
      min-width: 0;
      table-layout: fixed;
    }
    .cards-table thead {
      display: none;
    }
    .cards-table tbody {
      display: block;
      width: 100%;
    }
    .cards-table tr {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "name name"
        "bank group"
        "number pin"
        "received withdrawn"
        "commission balance"
        "actions actions";
      gap: 6px 12px;
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
    }
    .cards-table td {
      display: block;
      padding: 6px 0;
      border: none;
      min-width: 0;
    }
    .cards-table td:nth-child(4) {
      padding-right: 12px;
    }
    .cards-table td:nth-child(5) {
      padding-left: 12px;
    }
    .cards-table td::before {
      content: attr(data-label);
      display: block;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .cards-table td:nth-child(1) { grid-area: name; font-weight: 600; }
    .cards-table td:nth-child(2) { grid-area: bank; color: var(--muted); font-size: 0.9rem; }
    .cards-table td:nth-child(3) { grid-area: group; color: var(--muted); font-size: 0.9rem; }
    .cards-table td:nth-child(4) { grid-area: number; }
    .cards-table td:nth-child(5) { grid-area: pin; }
    .cards-table td:nth-child(6) { grid-area: received; color: var(--muted); font-size: 0.9rem; }
    .cards-table td:nth-child(7) { grid-area: withdrawn; color: var(--muted); font-size: 0.9rem; }
    .cards-table td:nth-child(8) { grid-area: commission; color: var(--muted); font-size: 0.9rem; }
    .cards-table td:nth-child(9) { grid-area: balance; color: var(--muted); font-size: 0.9rem; }
    .cards-table td:nth-child(10) { grid-area: actions; }
    .cards-table td:nth-child(3),
    .cards-table td:nth-child(5),
    .cards-table td:nth-child(7),
    .cards-table td:nth-child(9) {
      text-align: right;
    }
    .cards-table td:nth-child(3)::before,
    .cards-table td:nth-child(5)::before,
    .cards-table td:nth-child(7)::before,
    .cards-table td:nth-child(9)::before {
      text-align: right;
    }
    .cards-table td:nth-child(10)::before {
      content: "";
      margin-bottom: 0;
    }
  }
  .add-card-body .card-notes-field {
    display: flex;
    flex-direction: column;
    gap: 0;
  }
  .add-card-body .card-notes-field > span {
    margin-bottom: 0;
  }
  .add-card-body .card-notes-field .notes-field {
    border: 1px solid var(--border);
    background: #fff;
    min-height: 44px;
    padding: 10px 12px;
    gap: 0;
  }
  .add-card-body .card-notes-field .notes-header {
    justify-content: flex-end;
  }
  .add-card-body .card-notes-field .notes-trigger,
  .add-card-body .card-notes-field .notes-trigger:hover {
    background: transparent;
    color: var(--primary);
  }
</style>
<section class="section-card">
  <div class="add-card-toggle" role="button" tabindex="0" aria-expanded="{% if form.errors %}true{% else %}false{% endif %}">
    <h2 style="margin:0;">Add Card</h2>
  </div>
    <div class="add-card-body{% if form.errors %} is-open{% endif %}">
      <form method="post" class="form-grid cards-add-form">
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% for field in form %}
        {% if field.name == "notes" %}
          {% with has_value=field.value %}
        <label class="card-notes-field">
          <span>{{ field.label }}</span>
          <div class="notes-field{% if has_value or field.errors %} is-open{% endif %}">
            <div class="notes-header">
              <button type="button" class="notes-trigger" data-note-target="notes-{{ field.auto_id }}">Add note</button>
            </div>
            <div class="notes-collapse" id="notes-{{ field.auto_id }}">
              {{ field }}
              {% if field.errors %}
                <small style="color:#c00;">{{ field.errors|join:", " }}</small>
              {% endif %}
            </div>
          </div>
        </label>
          {% endwith %}
      {% elif field.name == "group_name" %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="combo-wrapper" data-combo-list="group-options">
            {{ field }}
            <div class="combo-dropdown"></div>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% elif field.name == "bank" %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="combo-wrapper" data-combo-list="bank-options">
            {{ field }}
            <div class="combo-dropdown"></div>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% else %}
        <label>
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          {{ field }}
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% endif %}
    {% endfor %}
      <div style="grid-column:1/-1;">
        <button type="submit" style="width:100%;">Add Card</button>
      </div>
    </form>
  </div>
</section>

<datalist id="group-options">
  {% for group in groups %}
    <option value="{{ group.name }}"></option>
  {% endfor %}
</datalist>
<datalist id="bank-options">
  {% for bank in banks %}
    <option value="{{ bank }}"></option>
  {% endfor %}
</datalist>


<section class="section-card">
  <div style="display:flex; flex-direction:column; gap:12px;">
    <div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; align-items:center;">
      <h2 style="margin:0;">Cards</h2>
      <a href="/cards/export/{% if bank_filter or group_filter or start or end or query %}?{% endif %}{% if bank_filter %}bank={{ bank_filter|urlencode }}{% if group_filter or start or end or query %}&{% endif %}{% endif %}{% if group_filter %}group={{ group_filter|urlencode }}{% if start or end or query %}&{% endif %}{% endif %}{% if start %}start={{ start|urlencode }}{% if end or query %}&{% endif %}{% endif %}{% if end %}end={{ end|urlencode }}{% if query %}&{% endif %}{% endif %}{% if query %}q={{ query|urlencode }}{% endif %}">Export CSV</a>
    </div>
    <form method="get" class="cards-filters" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; width:100%;">
      <label style="display:flex; flex-direction:column; min-width:200px;">
        <span>Bank</span>
        <div class="combo-wrapper" data-combo-list="bank-options" data-combo-target="cards-bank-filter">
          <input type="hidden" name="bank" id="cards-bank-filter" value="{{ bank_filter }}">
          <input type="text" value="{{ bank_filter }}" placeholder="Start typing bank..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="combo-input">
          <div class="combo-dropdown"></div>
        </div>
      </label>
      <label style="display:flex; flex-direction:column; min-width:200px;">
        <span>Group</span>
        <div class="combo-wrapper" data-combo-list="group-options" data-combo-target="cards-group-filter">
          <input type="hidden" name="group" id="cards-group-filter" value="{{ group_filter }}">
          <input type="text" value="{{ group_filter }}" placeholder="Start typing group..." autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" class="combo-input">
          <div class="combo-dropdown"></div>
        </div>
      </label>
      <label style="display:flex; flex-direction:column;">
        <span>From</span>
        <div class="date-field">
          <input type="text" name="start" placeholder="dd/mm/yyyy" value="{{ start }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
          <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
        </div>
      </label>
      <label style="display:flex; flex-direction:column;">
        <span>To</span>
        <div class="date-field">
          <input type="text" name="end" placeholder="dd/mm/yyyy" value="{{ end }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
          <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
        </div>
      </label>
      <label style="display:flex; flex-direction:column; min-width:220px; flex:1;">
        <span>Search</span>
        <input type="text" name="q" placeholder="Search cards..." value="{{ query }}">
      </label>
    </form>
  </div>

  <div class="table-card table-scroll mobile-cards" style="margin-top:16px;">
    <table class="cards-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Bank</th>
          <th>Group</th>
          <th>Number</th>
          <th>PIN</th>
          <th class="num col-narrow">Received ₽</th>
          <th class="num col-narrow">Withdrawn ₽</th>
          <th class="num col-narrow">Commission ₽</th>
          <th class="num col-narrow">Balance ₽</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for c in page_obj %}
          <tr>
            <td data-label="Name">{{ c.name }}</td>
            <td data-label="Bank">{{ c.bank }}</td>
            <td data-label="Group">{% if c.group %}{{ c.group.name }}{% else %}-{% endif %}</td>
            <td data-label="Number">{{ c.card_number }}</td>
            <td data-label="PIN">{{ c.pin }}</td>
            <td data-label="Received" class="num">{{ c.received_total|spaced_number }} ₽</td>
            <td data-label="Withdrawn" class="num">{{ c.withdrawn_total|spaced_number }} ₽</td>
            <td data-label="Commission" class="num">{{ c.commission_total|spaced_number }} ₽</td>
            <td data-label="Balance" class="num">{{ c.balance_total|spaced_number }} ₽</td>
            <td style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
              <a href="/cards/{{ c.id }}/edit/">Edit</a>
              <a href="/cards/{{ c.id }}/history/?start={{ start|urlencode }}&end={{ end|urlencode }}">History</a>
              <form method="post" action="{% url 'card_delete' c.id %}" style="display:inline;" onsubmit="return confirm('Delete this card?');">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}">
                <button type="submit" style="background:none;border:none;color:#c00;padding:0;margin:0;cursor:pointer;font:inherit;">Delete</button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {% if page_obj.has_other_pages %}
    <div class="pagination" style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
      {% if page_obj.has_previous %}
        <a href="?{% if bank_filter %}bank={{ bank_filter|urlencode }}&{% endif %}{% if group_filter %}group={{ group_filter|urlencode }}&{% endif %}{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Prev</a>
      {% endif %}
      {% for num in page_items %}
        {% if num %}
          {% if num == page_obj.number %}
            <span style="padding:4px 8px; border-radius:8px; background:#e2e8f0; font-weight:600;">{{ num }}</span>
          {% else %}
            <a href="?{% if bank_filter %}bank={{ bank_filter|urlencode }}&{% endif %}{% if group_filter %}group={{ group_filter|urlencode }}&{% endif %}{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ num }}" style="padding:4px 8px;">{{ num }}</a>
          {% endif %}
        {% else %}
          <span style="padding:4px 6px; color:var(--muted);">...</span>
        {% endif %}
      {% endfor %}
      {% if page_obj.has_next %}
        <a href="?{% if bank_filter %}bank={{ bank_filter|urlencode }}&{% endif %}{% if group_filter %}group={{ group_filter|urlencode }}&{% endif %}{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
      {% endif %}
    </div>
  {% endif %}

  <div class="table-card" style="margin-top:16px;">
    <table>
      <thead>
        <tr><th>Total Received</th><th>Total Withdrawn</th><th>Total Commission</th><th>Balance</th></tr>
      </thead>
      <tbody class="cards-totals-body">
        <tr>
          <td data-total="received">{{ overall.received|spaced_number }} ₽</td>
          <td data-total="withdrawn">{{ overall.withdrawn|spaced_number }} ₽</td>
          <td data-total="commission">{{ overall.commission|spaced_number }} ₽</td>
          <td data-total="balance">{{ overall.balance|spaced_number }} ₽</td>
        </tr>
      </tbody>
    </table>
  </div>
</section>
<script>
  (function () {
    const searchInput = document.querySelector("input[name='q']");
    const tbody = document.querySelector(".cards-table tbody");
    const pagination = document.querySelector(".pagination");
    const totalsBody = document.querySelector(".cards-totals-body");
    const exportLink = document.querySelector("a[href^='/cards/export/']");
    if (!searchInput || !tbody) return;

    const initialBody = tbody.innerHTML;
    const initialPagination = pagination ? pagination.innerHTML : "";
    const initialPaginationDisplay = pagination ? pagination.style.display : "";
    const initialTotals = totalsBody ? totalsBody.innerHTML : "";
    const initialExport = exportLink ? exportLink.href : "";
    let controller = null;
    let timer;

    function getValue(selector) {
      const el = document.querySelector(selector);
      return el ? el.value.trim() : "";
    }

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        return parts.pop().split(";").shift();
      }
      return "";
    }

    function buildParams(includeQuery) {
      const params = new URLSearchParams();
      const bank = getValue("#cards-bank-filter");
      const group = getValue("#cards-group-filter");
      const start = getValue("input[name='start']");
      const end = getValue("input[name='end']");
      const query = includeQuery ? searchInput.value.trim() : "";
      if (bank) params.set("bank", bank);
      if (group) params.set("group", group);
      if (start) params.set("start", start);
      if (end) params.set("end", end);
      if (query) params.set("q", query);
      return params;
    }

    function updateExportLink(queryParams) {
      if (!exportLink) return;
      const query = queryParams.toString();
      exportLink.href = query ? `/cards/export/?${query}` : "/cards/export/";
    }

    function renderTotals(totals) {
      if (!totalsBody || !totals) return;
      const received = totalsBody.querySelector("[data-total='received']");
      const withdrawn = totalsBody.querySelector("[data-total='withdrawn']");
      const commission = totalsBody.querySelector("[data-total='commission']");
      const balance = totalsBody.querySelector("[data-total='balance']");
      if (received) received.textContent = totals.received ? `${totals.received} ₽` : "";
      if (withdrawn) withdrawn.textContent = totals.withdrawn ? `${totals.withdrawn} ₽` : "";
      if (commission) commission.textContent = totals.commission ? `${totals.commission} ₽` : "";
      if (balance) balance.textContent = totals.balance ? `${totals.balance} ₽` : "";
    }

    function renderRows(items) {
      if (!items.length) {
        tbody.innerHTML = "<tr><td colspan=\"10\">No cards match the search.</td></tr>";
        return;
      }
      const csrf = getCookie("csrftoken");
      const start = getValue("input[name='start']");
      const end = getValue("input[name='end']");
      const historyParams = new URLSearchParams();
      if (start) historyParams.set("start", start);
      if (end) historyParams.set("end", end);
      const historySuffix = historyParams.toString() ? `?${historyParams.toString()}` : "";
      const nextValue = window.location.pathname + window.location.search;
      tbody.innerHTML = items
        .map(card => {
          const id = escapeHtml(card.id);
          const name = escapeHtml(card.name);
          const bank = escapeHtml(card.bank);
          const group = escapeHtml(card.group);
          const number = escapeHtml(card.card_number);
          const pin = escapeHtml(card.pin);
          const received = escapeHtml(card.received);
          const withdrawn = escapeHtml(card.withdrawn);
          const commission = escapeHtml(card.commission);
          const balance = escapeHtml(card.balance);
          return `
            <tr>
              <td data-label="Name">${name}</td>
              <td data-label="Bank">${bank}</td>
              <td data-label="Group">${group || "-"}</td>
              <td data-label="Number">${number}</td>
              <td data-label="PIN">${pin}</td>
              <td data-label="Received" class="num">${received} ₽</td>
              <td data-label="Withdrawn" class="num">${withdrawn} ₽</td>
              <td data-label="Commission" class="num">${commission} ₽</td>
              <td data-label="Balance" class="num">${balance} ₽</td>
              <td style="display:flex; gap:6px; flex-wrap:wrap; align-items:center;">
                <a href="/cards/${id}/edit/">Edit</a>
                <a href="/cards/${id}/history/${historySuffix}">History</a>
                <form method="post" action="/cards/${id}/delete/" style="display:inline;" onsubmit="return confirm('Delete this card?');">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${csrf}">
                  <input type="hidden" name="next" value="${escapeHtml(nextValue)}">
                  <button type="submit" style="background:none;border:none;color:#c00;padding:0;margin:0;cursor:pointer;font:inherit;">Delete</button>
                </form>
              </td>
            </tr>
          `;
        })
        .join("");
    }

    function togglePagination(show) {
      if (!pagination) return;
      pagination.style.display = show ? initialPaginationDisplay || "" : "none";
    }

    function restoreInitial() {
      tbody.innerHTML = initialBody;
      if (pagination) pagination.innerHTML = initialPagination;
      if (totalsBody) totalsBody.innerHTML = initialTotals;
      if (exportLink && initialExport) exportLink.href = initialExport;
      togglePagination(true);
    }

    function applySearch() {
      const term = searchInput.value.trim();
      const params = buildParams(true);
      updateExportLink(buildParams(term !== ""));
      if (!term) {
        restoreInitial();
        return;
      }
      togglePagination(false);
      if (controller) controller.abort();
      controller = new AbortController();
      const query = params.toString();
      fetch(`/cards/search/?${query}`, { signal: controller.signal })
        .then(resp => resp.ok ? resp.json() : { results: [], totals: null })
        .then(data => {
          renderRows(data.results || []);
          renderTotals(data.totals || null);
        })
        .catch(() => {});
    }

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });
    searchInput.addEventListener("input", () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(applySearch, 200);
    });
    const startInput = document.querySelector("input[name='start']");
    const endInput = document.querySelector("input[name='end']");
    if (startInput) {
      startInput.addEventListener("change", applySearch);
      startInput.addEventListener("input", () => {
        if (!startInput.value.trim()) {
          applySearch();
        }
      });
    }
    if (endInput) {
      endInput.addEventListener("change", applySearch);
      endInput.addEventListener("input", () => {
        if (!endInput.value.trim()) {
          applySearch();
        }
      });
    }
    document.addEventListener("click", (event) => {
      const target = event.target;
      if (target && target.matches("button[data-action='clear']")) {
        setTimeout(applySearch, 0);
      }
    });
    applySearch();
  })();
</script>
<script>
  (function () {
    const toggle = document.querySelector(".add-card-toggle");
    const body = document.querySelector(".add-card-body");
    if (!toggle || !body) return;
    function toggleBody() {
      const isOpen = body.classList.toggle("is-open");
      toggle.setAttribute("aria-expanded", isOpen ? "true" : "false");
    }
    toggle.addEventListener("click", toggleBody);
    toggle.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        toggleBody();
      }
    });
  })();
</script>
{% endblock %}
