{% extends "core/base.html" %}
{% load formatting %}
{% block content %}
<h2>{{ title }}</h2>

<form method="post" class="form-grid" style="max-width:560px;">
  {% csrf_token %}
  {{ form.non_field_errors }}
  {% for field in form %}
    {% if field.name == "notes" %}
      {% with has_value=field.value %}
      <div class="notes-field{% if has_value or field.errors %} is-open{% endif %}" style="grid-column:1/-1;">
        <div class="notes-header">
          <span>{{ field.label }}</span>
          <button type="button" class="notes-trigger" data-note-target="notes-{{ field.auto_id }}">Add note</button>
        </div>
        <div class="notes-collapse" id="notes-{{ field.auto_id }}">
          {{ field }}
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </div>
      </div>
      {% endwith %}
    {% elif field.name == "group_name" %}
      <label>
        <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
        <div class="combo-wrapper" data-combo-list="group-options">
          {{ field }}
          <div class="combo-dropdown"></div>
        </div>
        {% if field.errors %}
          <small style="color:#c00;">{{ field.errors|join:", " }}</small>
        {% endif %}
      </label>
    {% elif field.name == "bank" %}
      <label>
        <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
        <div class="combo-wrapper" data-combo-list="bank-options">
          {{ field }}
          <div class="combo-dropdown"></div>
        </div>
        {% if field.errors %}
          <small style="color:#c00;">{{ field.errors|join:", " }}</small>
        {% endif %}
      </label>
    {% else %}
      <label>
        <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
        {{ field }}
        {% if field.errors %}
          <small style="color:#c00;">{{ field.errors|join:", " }}</small>
        {% endif %}
      </label>
    {% endif %}
  {% endfor %}
  <div style="grid-column:1/-1; display:flex; justify-content:flex-end;">
    <button type="submit">Save</button>
  </div>
</form>

<datalist id="group-options">
  {% for group in groups %}
    <option value="{{ group.name }}"></option>
  {% endfor %}
</datalist>
<datalist id="bank-options">
  {% for bank in banks %}
    <option value="{{ bank }}"></option>
  {% endfor %}
</datalist>
{{ bank_colors|json_script:"bank-color-map" }}

<script>
  (function () {
    const bankInput = document.querySelector("input[name='bank']");
    const colorInput = document.querySelector("input[name='bank_color']");
    const mapEl = document.getElementById("bank-color-map");
    if (!bankInput || !colorInput || !mapEl) return;
    let bankColors = {};
    try {
      bankColors = JSON.parse(mapEl.textContent || "{}");
    } catch (e) {
      bankColors = {};
    }
    const bankColorsLower = {};
    Object.keys(bankColors).forEach((key) => {
      bankColorsLower[key.toLowerCase()] = bankColors[key];
    });

    function syncColorFromBank() {
      const bank = bankInput.value.trim().toLowerCase();
      if (bank && bankColorsLower[bank]) {
        colorInput.value = bankColorsLower[bank];
      }
    }

    function rememberColor() {
      const bank = bankInput.value.trim().toLowerCase();
      if (bank) {
        bankColorsLower[bank] = colorInput.value;
      }
    }

    bankInput.addEventListener("input", syncColorFromBank);
    bankInput.addEventListener("change", syncColorFromBank);
    bankInput.addEventListener("blur", syncColorFromBank);
    colorInput.addEventListener("input", rememberColor);

    const cardNumberInput = document.querySelector("input[name='card_number']");
    if (!cardNumberInput) return;
    function formatCardNumber(value) {
      const digits = value.replace(/\D/g, "");
      if (!digits) return "";
      return digits.match(/.{1,4}/g).join(" ");
    }
    function handleCardNumberInput() {
      cardNumberInput.value = formatCardNumber(cardNumberInput.value);
    }
    cardNumberInput.addEventListener("input", handleCardNumberInput);
    cardNumberInput.addEventListener("blur", handleCardNumberInput);
  })();
</script>

<p><a href="/cards/">Back to Cards</a></p>
{% endblock %}
