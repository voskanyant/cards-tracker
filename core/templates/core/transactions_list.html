{% extends "core/base.html" %}
{% load formatting %}
{% block content %}
<style>
  @media (max-width: 720px) {
    .transactions-filters {
      display: grid !important;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px 12px;
    }
    .transactions-filters .search-per-page-row {
      display: grid;
      grid-template-columns: minmax(0, 4fr) minmax(0, 1fr);
      gap: 10px 12px;
      grid-column: 1 / -1;
      align-items: end;
    }
    .transactions-filters .search-per-page-row label {
      display: flex;
      flex-direction: column;
      gap: 0;
    }
    .transactions-filters .search-per-page-row input,
    .transactions-filters .search-per-page-row select {
      min-height: 44px;
    }
    .transactions-filters .search-per-page-row .filter-search {
      grid-column: 1 / 2;
    }
    .transactions-filters .search-per-page-row .transactions-per-page {
      grid-column: 2 / 3;
    }
    .transactions-filters .filter-search {
      grid-column: 1 / 2;
    }
    .transactions-filters .transactions-per-page {
      grid-column: 2 / 3;
    }
    .transactions-filters label {
      min-width: 0 !important;
    }
    .transactions-table {
      width: 100%;
      min-width: 0;
      table-layout: fixed;
    }
    .transactions-table thead {
      display: none;
    }
    .transactions-table tbody {
      display: block;
      width: 100%;
    }
    .transactions-table tr {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-areas:
        "time rate"
        "client card"
        "rub usd"
        "actions actions";
      gap: 6px 12px;
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      margin-bottom: 12px;
    }
    .transactions-table td {
      display: block;
      padding: 6px 0;
      border: none;
      text-align: left;
      min-width: 0;
    }
    .transactions-table td::before {
      content: none;
    }
    .transactions-table td:nth-child(1),
    .transactions-table td:nth-child(2) {
      font-weight: 600;
    }
    .transactions-table td:nth-child(5),
    .transactions-table td:nth-child(6) {
      font-size: 0.9rem;
      color: var(--muted);
    }
    .transactions-table td:nth-child(7) {
      grid-column: 1 / -1;
      padding-top: 8px;
    }
    .transactions-table td:nth-child(1) { grid-area: time; }
    .transactions-table td:nth-child(6) { grid-area: rate; }
    .transactions-table td:nth-child(2) { grid-area: client; }
    .transactions-table td:nth-child(5) { grid-area: card; }
    .transactions-table td:nth-child(3) { grid-area: rub; }
    .transactions-table td:nth-child(4) { grid-area: usd; }
    .transactions-table td:nth-child(7) { grid-area: actions; }
  }
  .transactions-filters .search-per-page-row {
    display: flex;
    gap: 12px;
    align-items: flex-end;
    flex: 1 1 360px;
  }
  .transactions-filters .search-per-page-row label {
    min-width: 0;
  }
  .transactions-filters .search-per-page-row .filter-search {
    flex: 1 1 0;
  }
  .transactions-filters .search-per-page-row .transactions-per-page {
    flex: 0 0 140px;
  }
</style>
<div style="display:flex; flex-wrap:wrap; justify-content:space-between; gap:12px; align-items:center;">
  <h2 style="margin:0;">Transactions</h2>
  <a href="/transactions/export/{% if start or end or query %}?{% endif %}{% if start %}start={{ start|urlencode }}{% if end or query %}&{% endif %}{% endif %}{% if end %}end={{ end|urlencode }}{% if query %}&{% endif %}{% endif %}{% if query %}q={{ query|urlencode }}{% endif %}">Export CSV</a>
</div>

<section class="add-transaction section-card">
  <h3 style="margin-top:0;">Add Transaction</h3>
  <form method="post" style="display:flex; flex-wrap:wrap; gap:16px;">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for field in form %}
      {% if field.name == "tz_offset" or field.name == "original_timestamp" or field.name == "timestamp_initial" %}
        {{ field.as_hidden }}
      {% elif field.name == "card" %}
        <label style="display:flex; flex-direction:column; min-width:200px; flex:1;">
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="combo-wrapper">
            {{ field.as_hidden }}
            <input type="text" class="combo-input" data-combo-target="{{ field.auto_id }}" data-combo-list="card-options" placeholder="Start typing card..." value="{{ card_lookup|dict_get:field.value }}">
            <div class="combo-dropdown"></div>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% elif field.name == "client" %}
        <label style="display:flex; flex-direction:column; min-width:200px; flex:1;">
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="combo-wrapper">
            {{ field.as_hidden }}
            <input type="text" class="combo-input" data-combo-target="{{ field.auto_id }}" data-combo-list="client-options" placeholder="Start typing client..." value="{{ client_lookup|dict_get:field.value }}">
            <div class="combo-dropdown"></div>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% elif field.name == "notes" %}
        {% with has_value=field.value %}
        <div class="notes-field{% if has_value or field.errors %} is-open{% endif %}" style="flex:1 1 100%;">
          <div class="notes-header">
            <span>{{ field.label }}</span>
            <button type="button" class="notes-trigger" data-note-target="notes-{{ field.auto_id }}">Add note</button>
          </div>
          <div class="notes-collapse" id="notes-{{ field.auto_id }}">
            {{ field }}
            {% if field.errors %}
              <small style="color:#c00;">{{ field.errors|join:", " }}</small>
            {% endif %}
          </div>
        </div>
        {% endwith %}
      {% elif field.name == "timestamp" %}
        <label style="display:flex; flex-direction:column; min-width:150px; flex:0.6;">
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="date-field">
            {{ field }}
            <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% elif field.name == "amount_rub" or field.name == "amount_usd" %}
        <label style="display:flex; flex-direction:column; min-width:130px; flex:0.45;">
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          <div class="currency-input">
            <span class="currency-prefix">{% if field.name == "amount_rub" %}&#8381;{% else %}${% endif %}</span>
            {{ field }}
          </div>
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% else %}
        <label style="display:flex; flex-direction:column; min-width:140px; flex:0.6;">
          <span>{{ field.label }}{% if field.field.required %} *{% endif %}</span>
          {{ field }}
          {% if field.errors %}
            <small style="color:#c00;">{{ field.errors|join:", " }}</small>
          {% endif %}
        </label>
      {% endif %}
    {% endfor %}
    <div style="align-self:flex-end;">
      <button type="submit">Save</button>
    </div>
  </form>
</section>

<datalist id="card-options">
  {% for card in cards %}
    <option data-id="{{ card.id }}" value="{{ card.display_label }}"></option>
  {% endfor %}
</datalist>
<datalist id="client-options">
  {% for client in clients %}
    <option data-id="{{ client.id }}" value="{{ client.name }}"></option>
  {% endfor %}
</datalist>

<form method="get" class="filters section-card transactions-filters" style="margin-bottom:16px; display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end;">
  <label style="display:flex; flex-direction:column;">
    <span>From</span>
    <div class="date-field">
      <input type="text" name="start" placeholder="dd/mm/yyyy" value="{{ start }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
      <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
    </div>
  </label>
  <label style="display:flex; flex-direction:column;">
    <span>To</span>
    <div class="date-field">
      <input type="text" name="end" placeholder="dd/mm/yyyy" value="{{ end }}" autocomplete="off" inputmode="numeric" class="date-input js-date-input">
      <button type="button" class="calendar-toggle" aria-label="Open calendar">&#128197;</button>
    </div>
  </label>
  <div class="search-per-page-row">
    <label class="filter-search" style="display:flex; flex-direction:column; min-width:200px; flex:1;">
      <span>Search</span>
      <input type="text" name="q" placeholder="Search client/card/notes..." value="{{ query }}">
    </label>
    <label class="transactions-per-page" style="display:flex; flex-direction:column; min-width:140px;">
      <span>Per page</span>
      <select name="per_page">
        {% for option in per_page_choices %}
          <option value="{{ option }}" {% if option == per_page %}selected{% endif %}>{{ option }}</option>
        {% endfor %}
      </select>
    </label>
  </div>
</form>

<div class="table-card table-scroll mobile-cards">
<table class="transactions-table">
  <thead>
    <tr><th>Time</th><th>Client</th><th>RUB &#8381;</th><th>USD $</th><th>Card</th><th>Rate &#8381;</th><th>Actions</th></tr>
  </thead>
  <tbody>
    {% for t in page_obj %}
      <tr>
        <td data-label="Time" data-utc="{{ t.timestamp|date:'c' }}"></td>
        <td data-label="Client">{{ t.client.name }}</td>
        <td data-label="RUB &#8381;">{{ t.amount_rub|spaced_number }} &#8381;</td>
        <td data-label="USD $">{{ t.amount_usd|spaced_number }} $</td>
        <td data-label="Card">{{ t.card_display }}</td>
        <td data-label="Rate &#8381;">{{ t.rate|spaced_number }} &#8381;</td>
        <td data-label="Actions">
          <a href="/transactions/{{ t.id }}/edit/">Edit</a>
          <form method="post" action="{% url 'transaction_delete' t.id %}" style="display:inline;" onsubmit="return confirm('Delete this transaction?');">
            {% csrf_token %}
            <input type="hidden" name="next" value="{{ request.get_full_path }}">
            <button type="submit" style="background:none;border:none;color:#c00;padding:0 0 0 8px;cursor:pointer;font:inherit;">Delete</button>
          </form>
        </td>
      </tr>
    {% empty %}
      <tr><td colspan="7">No transactions match the selected filters.</td></tr>
    {% endfor %}
  </tbody>
</table>
</div>

{% if page_obj.has_other_pages %}
  <div class="pagination" style="margin-top:16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
    {% if page_obj.has_previous %}
      <a href="?{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">Prev</a>
    {% endif %}
    {% for num in page_items %}
      {% if num %}
        {% if num == page_obj.number %}
          <span style="padding:4px 8px; border-radius:8px; background:#e2e8f0; font-weight:600;">{{ num }}</span>
        {% else %}
          <a href="?{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ num }}" style="padding:4px 8px;">{{ num }}</a>
        {% endif %}
      {% else %}
        <span style="padding:4px 6px; color:var(--muted);">...</span>
      {% endif %}
    {% endfor %}
    {% if page_obj.has_next %}
      <a href="?{% if start %}start={{ start|urlencode }}&{% endif %}{% if end %}end={{ end|urlencode }}&{% endif %}{% if query %}q={{ query|urlencode }}&{% endif %}per_page={{ per_page }}&page={{ page_obj.next_page_number }}">Next</a>
    {% endif %}
  </div>
{% endif %}
<script>
  (function () {
    const cache = {};

    function getOptions(listId) {
      if (!cache[listId]) {
        const listEl = document.getElementById(listId);
        cache[listId] = listEl
          ? Array.from(listEl.querySelectorAll("option")).map(opt => ({
              id: opt.dataset.id,
              label: opt.value
            }))
          : [];
      }
      return cache[listId];
    }

    function renderDropdown(dropdown, options, hidden, input) {
      dropdown.innerHTML = "";
      if (!options.length) {
        dropdown.style.display = "none";
        return;
      }
      options.forEach(opt => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = opt.label;
        btn.dataset.id = opt.id;
        dropdown.appendChild(btn);
      });
      dropdown.style.display = "block";
      dropdown.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          hidden.value = btn.dataset.id || "";
          input.value = btn.textContent;
          dropdown.style.display = "none";
        });
      });
    }

    document.querySelectorAll(".combo-wrapper").forEach(wrapper => {
      const input = wrapper.querySelector(".combo-input");
      const hidden = wrapper.querySelector("input[type='hidden']");
      const dropdown = wrapper.querySelector(".combo-dropdown");
      if (!input || !hidden || !dropdown) return;
      const listId = input.dataset.comboList;
      if (!listId) return;

      const allOptions = getOptions(listId);

      function syncFromHidden() {
        if (!hidden.value) return;
        const match = allOptions.find(opt => opt.id === hidden.value);
        if (match) input.value = match.label;
      }

      function filterOptions(term) {
        const t = term.trim().toLowerCase();
        if (!t) {
          return allOptions.slice(0, 8);
        }
        return allOptions.filter(opt => opt.label.toLowerCase().includes(t)).slice(0, 8);
      }

      input.addEventListener("focus", () => {
        renderDropdown(dropdown, filterOptions(input.value), hidden, input);
      });

      input.addEventListener("input", () => {
        hidden.value = "";
        renderDropdown(dropdown, filterOptions(input.value), hidden, input);
      });

      input.addEventListener("keydown", (e) => {
        if (e.key === "Escape") {
          dropdown.style.display = "none";
        }
      });

      document.addEventListener("click", (e) => {
        if (!wrapper.contains(e.target)) {
          dropdown.style.display = "none";
        }
      });

      syncFromHidden();
    });
  })();
</script>
<script>
  (function () {
    const searchInput = document.querySelector("input[name='q']");
    const tbody = document.querySelector(".table-card table tbody");
    const pagination = document.querySelector(".pagination");
    const perPageLabel = document.querySelector(".transactions-per-page");
    const exportLink = document.querySelector("a[href^='/transactions/export/']");
    if (!searchInput || !tbody) return;

    const initialBody = tbody.innerHTML;
    const initialPagination = pagination ? pagination.innerHTML : "";
    const initialPaginationDisplay = pagination ? pagination.style.display : "";
    const initialExport = exportLink ? exportLink.href : "";
    let controller = null;
    let timer;

    function escapeHtml(value) {
      return String(value || "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) {
        return parts.pop().split(";").shift();
      }
      return "";
    }

    function getValue(selector) {
      const el = document.querySelector(selector);
      return el ? el.value.trim() : "";
    }

    function buildParams(includeQuery) {
      const params = new URLSearchParams();
      const start = getValue("input[name='start']");
      const end = getValue("input[name='end']");
      const query = includeQuery ? searchInput.value.trim() : "";
      if (start) params.set("start", start);
      if (end) params.set("end", end);
      if (query) params.set("q", query);
      return params;
    }

    function updateExportLink(queryParams) {
      if (!exportLink) return;
      const query = queryParams.toString();
      exportLink.href = query ? `/transactions/export/?${query}` : "/transactions/export/";
    }

    function renderRows(items) {
      if (!items.length) {
        tbody.innerHTML = "<tr><td colspan=\"7\">No transactions match the search.</td></tr>";
        return;
      }
      const csrf = getCookie("csrftoken");
      const nextValue = window.location.pathname + window.location.search;
      tbody.innerHTML = items
        .map(tx => {
          const id = escapeHtml(tx.id);
          const client = escapeHtml(tx.client);
          const card = escapeHtml(tx.card);
          const rub = escapeHtml(tx.rub);
          const usd = escapeHtml(tx.usd);
          const rate = escapeHtml(tx.rate);
          const timeIso = escapeHtml(tx.time_iso);
          return `
            <tr>
              <td data-label="Time" data-utc="${timeIso}"></td>
              <td data-label="Client">${client}</td>
              <td data-label="RUB &#8381;">${rub} &#8381;</td>
              <td data-label="USD $">${usd} $</td>
              <td data-label="Card">${card}</td>
              <td data-label="Rate &#8381;">${rate} &#8381;</td>
              <td data-label="Actions">
                <a href="/transactions/${id}/edit/">Edit</a>
                <form method="post" action="/transactions/${id}/delete/" style="display:inline;" onsubmit="return confirm('Delete this transaction?');">
                  <input type="hidden" name="csrfmiddlewaretoken" value="${csrf}">
                  <input type="hidden" name="next" value="${escapeHtml(nextValue)}">
                  <button type="submit" style="background:none;border:none;color:#c00;padding:0 0 0 8px;cursor:pointer;font:inherit;">Delete</button>
                </form>
              </td>
            </tr>
          `;
        })
        .join("");
    }

    function togglePagination(show) {
      if (!pagination) return;
      pagination.style.display = show ? initialPaginationDisplay || "" : "none";
    }

    function togglePerPage(show) {
      if (!perPageLabel) return;
      perPageLabel.style.display = show ? "" : "none";
    }

    function restoreInitial() {
      tbody.innerHTML = initialBody;
      if (pagination) pagination.innerHTML = initialPagination;
      if (exportLink && initialExport) exportLink.href = initialExport;
      togglePagination(true);
      togglePerPage(true);
      formatUtcCells();
    }

    function formatUtcCells() {
      const offsetCookie = getCookie("tz_offset");
      const offsetMinutes = offsetCookie ? parseInt(offsetCookie, 10) : new Date().getTimezoneOffset();
      document.querySelectorAll("td[data-utc]").forEach(cell => {
        const raw = cell.getAttribute("data-utc");
        if (!raw) return;
        const date = new Date(raw);
        if (Number.isNaN(date.getTime())) return;
        const offset = Number.isNaN(offsetMinutes) ? new Date().getTimezoneOffset() : offsetMinutes;
        const localMillis = date.getTime() - offset * 60000;
        const localDate = new Date(localMillis);
        const dd = String(localDate.getUTCDate()).padStart(2, "0");
        const mm = String(localDate.getUTCMonth() + 1).padStart(2, "0");
        const yyyy = localDate.getUTCFullYear();
        const hh = String(localDate.getUTCHours()).padStart(2, "0");
        const min = String(localDate.getUTCMinutes()).padStart(2, "0");
        cell.textContent = `${dd}/${mm}/${yyyy} ${hh}:${min}`;
      });
    }

    function applyFilters() {
      const start = getValue("input[name='start']");
      const end = getValue("input[name='end']");
      const term = searchInput.value.trim();
      const hasFilters = Boolean(start || end || term);
      updateExportLink(buildParams(hasFilters));
      if (!hasFilters) {
        restoreInitial();
        return;
      }
      togglePagination(false);
      togglePerPage(false);
      if (controller) controller.abort();
      controller = new AbortController();
      const params = buildParams(true);
      fetch(`/transactions/search/?${params.toString()}`, { signal: controller.signal })
        .then(resp => resp.ok ? resp.json() : { results: [] })
        .then(data => {
          renderRows(data.results || []);
          formatUtcCells();
        })
        .catch(() => {});
    }

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });
    searchInput.addEventListener("input", () => {
      window.clearTimeout(timer);
      timer = window.setTimeout(applyFilters, 200);
    });
    const startInput = document.querySelector("input[name='start']");
    const endInput = document.querySelector("input[name='end']");
    if (startInput) {
      startInput.addEventListener("change", applyFilters);
      startInput.addEventListener("input", () => {
        if (!startInput.value.trim()) {
          applyFilters();
        }
      });
    }
    if (endInput) {
      endInput.addEventListener("change", applyFilters);
      endInput.addEventListener("input", () => {
        if (!endInput.value.trim()) {
          applyFilters();
        }
      });
    }
    document.addEventListener("click", (event) => {
      const target = event.target;
      if (target && target.matches("button[data-action='clear']")) {
        setTimeout(applyFilters, 0);
      }
    });
    formatUtcCells();
    applyFilters();
  })();
</script>
<script>
  (function () {
    const offset = new Date().getTimezoneOffset();
    document.querySelectorAll(".js-tz-offset").forEach(input => {
      input.value = offset;
    });
  })();
</script>
{% endblock %}

